**Для кого:** разработчики

**Что:** технические детали реализации

[[_TOC_]]

Этот документ описывает неочевидные моменты, и причины решений.
Некоторые части систнмы могут быть не упомянуты из-за своей простоты.

---

### Общая архитектура

Аналитика сделана на Python (без R) плюс numpy, scipy, scikit-learn, pandas, matplotlib.
Я решил отказаться от R, т.к. он не предоставляет достаточно плюсов.
Единственный плюс R - наличие специфичных библиотек, но они почти все портированы на Python.
С другой стороны - надо тащить R-рантайм, аккуратно пробрасывать аргументы и обрабатывать ошибки и краши.

#### datasets

Excel-файлы имеют вполне четкую структуру, поэтому при их чтении автоматически заполняются NaN-ы и т.д.

#### map_locations

Маркеры на карте.
Сделаны отдельно от датасетов на будущее, т.к. возможно у одного датасета будет несколько маркеров.

#### statistics

Модуль статистики и аналитики.
Каждый вид анализа сделан как две страницы - основная, на которой выбираются параметры (датасет, столбцы, метод и т.п.) и страница результатов.
Первая выглядит как многоэтапная форма, вторая - статичная страница с результатами.
Соответственно, по две view-функции, которые возвращают данные необходимые для рендера шаблонов.

view-функции только обрабатывают пользовательский ввод и отображают результат.
Аналитика (расчет корреляций и т.п.) выполняется функциями из [statistics.py](../avarus/apps/statistics/statistics.py).


### Структура директорий

`media/tmp` - в этой директории хранятся результаты анализа (excel, графики).

`data` - тут лежат сертификаты для https.

---

### Frontend

Фронт написан на ванильном js плюс Bootstrap 5.
Я пытался сделать максимально просто, чтобы не тащить зависимости и было проще редактировать (если понадобится).

В некоторых мульти-чекбокс формах есть галочка - выбрать все.

Валидации форм на фронте нет.

---

### Hacks

#### http_referer в nginx.conf

Django при смене языка посылает POST-запрос на специальный адрес.
Из-за того, что nginx пробрасывает все запросы нужно изменять `http_referer`, иначе смена языка будет всегда сбрасывать на главную.

Я не знаю возможно ли сделать изящнее.

---

### Utils

#### Cleanup
ВАЖНО: инструкция ниже - черновик, выполняйте команды только если понимаете что они делают и сделали бекап.

---

Может быть полезно удалить устаревшие файлы, которые теперь не используются - например, env и spp excel-файлы, картинки.

Пример, последовательности действий для удаления неиспользуемых env-файлов.

Зайти в django докер-контейнер
```bash
docker exec -it django19001-v2 bash
```

Зайти в шелл Django
```bash
python manage.py shell
```

Шелл работает как интерактивный Python.
Читаем файлы, которые физически есть в директории, сравниваем с теми, которые используются в модели, перемещаем разницу во временную директорию.
```python
from apps.datasets.models import Dataset
import os

UNUSED_FILES = 'unused_files'
os.makedirs(UNUSED_FILES, exist_ok=True)

all_files = os.listdir('media/datasets/env/')
referenced_files = [i.env.path for i in Dataset.objects.all()]
to_delete_files = set(all_files) - set(referenced_files)

for i in to_delete_files:
    os.replace(i, f'{UNUSED_FILES}/{i}')
```

Выходим из Django-шелла в bash докера.
Провверям что на сайте ничего не сломалось (изображения не исчезли, скаичивание датасетов работает) и удаляем временную директорию.

```bash
rm -r unused_files
```

---

#### MD -> pdf

Может быть полезно сконвертировать документацию из маркдауна в pdf, т.к. доступ к репозиторию есть не у всех и pdf привычнее.

Я использовал расширение `Markdown PDF` для VS Code.
Работает из коробки, но мало настроек.

Есть вариант использовать `pandoc`, но он тянет 2 Гб зависимостей LaTeX-а и немного нетривиально работает с русскими буквами.
